(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{69:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return i})),t.d(n,"metadata",(function(){return s})),t.d(n,"toc",(function(){return l})),t.d(n,"default",(function(){return u}));var r=t(3),a=t(7),o=(t(0),t(97)),i={id:"ruoyi",title:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",sidebar_label:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",slug:"/app-info/ruoyi"},s={unversionedId:"app-info/java/ruoyi",id:"app-info/java/ruoyi",isDocsHomePage:!1,title:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",description:"1.\u5347\u7ea7jdk\u523015",source:"@site/docs/app-info/java/ruoyi.md",sourceDirName:"app-info/java",slug:"/app-info/ruoyi",permalink:"/developer-qa/docs/app-info/ruoyi",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/app-info/java/ruoyi.md",version:"current",lastUpdatedAt:1622019701,formattedLastUpdatedAt:"5/26/2021",sidebar_label:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",frontMatter:{id:"ruoyi",title:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",sidebar_label:"ruoyi\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",slug:"/app-info/ruoyi"},sidebar:"docs",previous:{title:"java\u5e38\u89c1\u8fd0\u7ef4\u95ee\u9898",permalink:"/developer-qa/docs/app-info/java"},next:{title:"ruoyi-vue\u524d\u7aef\u5e38\u89c1\u95ee\u9898",permalink:"/developer-qa/docs/app-info/ruoyifontend"}},l=[{value:"1.\u5347\u7ea7jdk\u523015",id:"1\u5347\u7ea7jdk\u523015",children:[{value:"1.Execution default of goal org.springframework.boot:spring-boot-maven-plugin:2.1.1.RELEASE:repackage failed: Unsupported class file major version 59 -&gt; Help 1",id:"1execution-default-of-goal-orgspringframeworkbootspring-boot-maven-plugin211releaserepackage-failed-unsupported-class-file-major-version-59---help-1",children:[]},{value:"2.ruoyi-framework \u7684\u6a21\u5757\u4e0b\u52a0\u4ee5\u4e0b\u4f9d\u8d56",id:"2ruoyi-framework-\u7684\u6a21\u5757\u4e0b\u52a0\u4ee5\u4e0b\u4f9d\u8d56",children:[]},{value:"3.\u767b\u5f55\u51fa\u73b0DatatypeConverter\u5f02\u5e38",id:"3\u767b\u5f55\u51fa\u73b0datatypeconverter\u5f02\u5e38",children:[]}]},{value:"2.ruoyi-vue\u81ea\u5b9a\u4e49\u5bc6\u7801\u5339\u914d\u5668",id:"2ruoyi-vue\u81ea\u5b9a\u4e49\u5bc6\u7801\u5339\u914d\u5668",children:[{value:"(1).\u7b2c\u4e00\u6b65:\u91cd\u5199SecurityUtils.encryptPassword,SecurityUtils.matchesPassword\u8fd9\u4e24\u4e2a\u65b9\u6cd5",id:"1\u7b2c\u4e00\u6b65\u91cd\u5199securityutilsencryptpasswordsecurityutilsmatchespassword\u8fd9\u4e24\u4e2a\u65b9\u6cd5",children:[]},{value:"(2).\u7b2c\u4e8c\u6b65:\u5728SecurityConfig\u7c7b\u91cc\u914d\u7f6e\u81ea\u5df1\u7684\u5bc6\u7801\u5339\u914d\u5668",id:"2\u7b2c\u4e8c\u6b65\u5728securityconfig\u7c7b\u91cc\u914d\u7f6e\u81ea\u5df1\u7684\u5bc6\u7801\u5339\u914d\u5668",children:[]}]},{value:"3.\u5728ruoyi-vue\u52a0\u8c37\u6b4c\u9a8c\u8bc1\u7801",id:"3\u5728ruoyi-vue\u52a0\u8c37\u6b4c\u9a8c\u8bc1\u7801",children:[{value:"(1).\u540e\u7aef\u7684\u6dfb\u52a0",id:"1\u540e\u7aef\u7684\u6dfb\u52a0",children:[]},{value:"(2). \u524d\u7aef\u7684\u6dfb\u52a0",id:"2-\u524d\u7aef\u7684\u6dfb\u52a0",children:[]}]},{value:"4.\u5b57\u6bb5\u65e5\u671f\u683c\u5f0f\u5316",id:"4\u5b57\u6bb5\u65e5\u671f\u683c\u5f0f\u5316",children:[]},{value:"5.\u81ea\u5b9a\u4e49dto\u8f6c\u5316\u5668,\u5982,\u628a\u6570\u7ec4\u8f6c\u6210String",id:"5\u81ea\u5b9a\u4e49dto\u8f6c\u5316\u5668\u5982\u628a\u6570\u7ec4\u8f6c\u6210string",children:[]},{value:"6.\u5e38\u89c1mybatis\u5b9e\u4f53html",id:"6\u5e38\u89c1mybatis\u5b9e\u4f53html",children:[]},{value:"7. import\u5bfc\u5165\u7684\u5b9e\u73b0",id:"7-import\u5bfc\u5165\u7684\u5b9e\u73b0",children:[{value:"(1) java \u5b9e\u73b0",id:"1-java-\u5b9e\u73b0",children:[]},{value:"(2) vue\u5b9e\u73b0",id:"2-vue\u5b9e\u73b0",children:[]}]},{value:"8.ruoyi\u591a\u6570\u636e\u6e90",id:"8ruoyi\u591a\u6570\u636e\u6e90",children:[]}],c={toc:l};function u(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"1\u5347\u7ea7jdk\u523015"},"1.\u5347\u7ea7jdk\u523015"),Object(o.b)("h3",{id:"1execution-default-of-goal-orgspringframeworkbootspring-boot-maven-plugin211releaserepackage-failed-unsupported-class-file-major-version-59---help-1"},"1.Execution default of goal org.springframework.boot:spring-boot-maven-plugin:2.1.1.RELEASE:repackage failed: Unsupported class file major version 59 -> ","[Help 1]"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},"\n<groupId>org.springframework.boot</groupId>\n<artifactId>spring-boot-maven-plugin</artifactId>\n<version>2.1.1.RELEASE</version>\n<configuration>\n<fork>true</fork> \x3c!-- \u5982\u679c\u6ca1\u6709\u8be5\u914d\u7f6e\uff0cdevtools\u4e0d\u4f1a\u751f\u6548 --\x3e\n</configuration>\n")),Object(o.b)("p",null,"\u8fd9\u91cc\u52a0spring-boot-maven-plugin\u63d2\u4ef6\u8981\u52a0class\u5165\u53e3:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},"\n<mainClass>com.ruoyi.RuoYiApplication</mainClass>\n        \u5982:\n\n<groupId>org.springframework.boot</groupId>\n<artifactId>spring-boot-maven-plugin</artifactId>\n<version>2.1.1.RELEASE</version>\n<configuration>\n<fork>true</fork> \x3c!-- \u5982\u679c\u6ca1\u6709\u8be5\u914d\u7f6e\uff0cdevtools\u4e0d\u4f1a\u751f\u6548 --\x3e\n<mainClass>com.ruoyi.RuoYiApplication</mainClass>\n</configuration>\n\n")),Object(o.b)("h3",{id:"2ruoyi-framework-\u7684\u6a21\u5757\u4e0b\u52a0\u4ee5\u4e0b\u4f9d\u8d56"},"2.ruoyi-framework \u7684\u6a21\u5757\u4e0b\u52a0\u4ee5\u4e0b\u4f9d\u8d56"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},"\n<dependency>\n    <groupId>javax.xml.bind</groupId>\n    <artifactId>jaxb-api</artifactId>\n    <version>2.3.0</version>\n</dependency>\n")),Object(o.b)("h3",{id:"3\u767b\u5f55\u51fa\u73b0datatypeconverter\u5f02\u5e38"},"3.\u767b\u5f55\u51fa\u73b0DatatypeConverter\u5f02\u5e38"),Object(o.b)("p",null,Object(o.b)("a",{parentName:"p",href:"http://doc.ruoyi.vip/ruoyi-cloud/other/faq.html#%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E8%B6%85%E7%BA%A7%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81"},"\u53c2\u8003\u6587\u6863\u6765\u6e90")),Object(o.b)("p",null,"\u9519\u8bef\u63d0\u793a\uff1a",Object(o.b)("inlineCode",{parentName:"p"},"Handler dispatch failed; nested exception is java.lang.NoClassDefFoundError: javax/xml/bind/DatatypeConverter")),Object(o.b)("p",null,"\u7531\u4e8e",Object(o.b)("inlineCode",{parentName:"p"},">= jdk9"),"\u4e2d\u4e0d\u518d\u5305\u542b\u8fd9\u4e2a",Object(o.b)("inlineCode",{parentName:"p"},"jar"),"\u5305\uff0c\u6240\u4ee5\u9700\u8981\u5728",Object(o.b)("inlineCode",{parentName:"p"},"ruoyi-framework\\pom.xml"),"\u624b\u52a8\u6dfb\u52a0\u4f9d\u8d56\u3002"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},"\n<dependency>\n    <groupId>javax.xml.bind</groupId>\n    <artifactId>jaxb-api</artifactId>\n    <version>2.3.0</version>\n</dependency>\n")),Object(o.b)("h2",{id:"2ruoyi-vue\u81ea\u5b9a\u4e49\u5bc6\u7801\u5339\u914d\u5668"},"2.ruoyi-vue\u81ea\u5b9a\u4e49\u5bc6\u7801\u5339\u914d\u5668"),Object(o.b)("h3",{id:"1\u7b2c\u4e00\u6b65\u91cd\u5199securityutilsencryptpasswordsecurityutilsmatchespassword\u8fd9\u4e24\u4e2a\u65b9\u6cd5"},"(1).\u7b2c\u4e00\u6b65:\u91cd\u5199SecurityUtils.encryptPassword,SecurityUtils.matchesPassword\u8fd9\u4e24\u4e2a\u65b9\u6cd5"),Object(o.b)("p",null,"\u5982:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"}," /**\n     * \u751f\u6210BCryptPasswordEncoder\u5bc6\u7801\n     *\n     * @param password \u5bc6\u7801\n     * @return \u52a0\u5bc6\u5b57\u7b26\u4e32\n     */\n    public static String encryptPassword(String password)\n    {\n        return PHPpassword.PHPpasswordHash(password);\n    }\n\n    /**\n     * \u5224\u65ad\u5bc6\u7801\u662f\u5426\u76f8\u540c\n     *\n     * @param rawPassword \u771f\u5b9e\u5bc6\u7801\n     * @param encodedPassword \u52a0\u5bc6\u540e\u5b57\u7b26\n     * @return \u7ed3\u679c\n     */\n    public static boolean matchesPassword(String rawPassword, String encodedPassword)\n    {\n        return PHPpassword.PHPpasswordVerify(rawPassword,encodedPassword);\n    }\n\n")),Object(o.b)("p",null,"PHPpassword.java\u5185\u5bb9:"),Object(o.b)("p",null,"xml\u4f9d\u8d56:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},"\x3c!--\u7528\u4e8ePHP\u5bc6\u7801\u517c\u5bb9PHPpasswordHash\u548cPHPpasswordVerify\u65b9\u6cd5--\x3e\n<dependency>\n    <groupId>at.favre.lib</groupId>\n    <artifactId>bcrypt</artifactId>\n    <version>0.9.0</version>\n</dependency>\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'package com.ruoyi.common.utils;\n\nimport at.favre.lib.crypto.bcrypt.BCrypt;\n\npublic class PHPpassword {\n    public static void main(String[] args) {\n        String password = "admin123";\n        String hash = PHPpasswordHash(password);\n        System.out.println(hash);\n        boolean b = PHPpasswordVerify(password, hash);\n        boolean b2 = PHPpasswordVerify(password, "$2a$13$jIFK.m0PK3xWEqAGoHi5keRblfKO./A2AU/YTOt5Q.VrQIhTKqhde");\n        System.out.println(b);\n        System.out.println(b2);\n    }\n\n    /**\n     * java\u7248\u672c\u7684passwordHash\n     *\n     * @param password\n     * @return\n     */\n    public static String PHPpasswordHash(String password) {\n        return BCrypt.withDefaults().hashToString(13, password.toCharArray());\n    }\n\n    /**\n     * \u9a8c\u8bc1passsword\n     *\n     * @param password\n     * @param hashphpassword\n     * @return\n     */\n    public static boolean PHPpasswordVerify(String password, String hashphpassword) {\n        BCrypt.Result res = BCrypt.verifyer().verify(password.toCharArray(), hashphpassword);\n        return res.verified;\n    }\n}\n\n')),Object(o.b)("h3",{id:"2\u7b2c\u4e8c\u6b65\u5728securityconfig\u7c7b\u91cc\u914d\u7f6e\u81ea\u5df1\u7684\u5bc6\u7801\u5339\u914d\u5668"},"(2).\u7b2c\u4e8c\u6b65:\u5728SecurityConfig\u7c7b\u91cc\u914d\u7f6e\u81ea\u5df1\u7684\u5bc6\u7801\u5339\u914d\u5668"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"  @Bean\n    public AuthenticationProvider authenticationProvider() {\n        AuthenticationProvider authenticationProvider = new MyAuthenticationProvider();\n        return authenticationProvider;\n    }\n")),Object(o.b)("p",null,"MyAuthenticationProvider\u7c7b\u7684\u5185\u5bb9:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'package com.ruoyi.framework.security.service;\n\nimport com.ruoyi.common.exception.user.UserPasswordNotMatchException;\nimport com.ruoyi.common.utils.PHPpassword;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.security.authentication.AuthenticationProvider;\nimport org.springframework.security.authentication.DisabledException;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.AuthenticationException;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.stereotype.Component;\n\nimport java.util.Collection;\n\n@Component\npublic class MyAuthenticationProvider implements AuthenticationProvider {\n\n    @Qualifier("userDetailsServiceImpl")\n    @Autowired\n    private UserDetailsService userService;\n\n    /**\n     * \u81ea\u5b9a\u4e49\u9a8c\u8bc1\u65b9\u5f0f\n     */\n    @Override\n    public Authentication authenticate(Authentication authentication) throws AuthenticationException {\n        String username = authentication.getName();\n        String password = (String) authentication.getCredentials();\n        UserDetails user = userService.loadUserByUsername(username);\n        if (!PHPpassword.PHPpasswordVerify(password,user.getPassword())) {\n            throw new UserPasswordNotMatchException();\n        }\n\n        Collection<? extends GrantedAuthority> authorities = user.getAuthorities();\n        return new UsernamePasswordAuthenticationToken(user, password, authorities);\n    }\n\n    @Override\n    public boolean supports(Class<?> arg0) {\n        return true;\n    }\n}\n\n')),Object(o.b)("h2",{id:"3\u5728ruoyi-vue\u52a0\u8c37\u6b4c\u9a8c\u8bc1\u7801"},"3.\u5728ruoyi-vue\u52a0\u8c37\u6b4c\u9a8c\u8bc1\u7801"),Object(o.b)("h3",{id:"1\u540e\u7aef\u7684\u6dfb\u52a0"},"(1).\u540e\u7aef\u7684\u6dfb\u52a0"),Object(o.b)("h4",{id:"\u4e00-applicationyml-\u6dfb\u52a0"},"\u4e00. application.yml \u6dfb\u52a0"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-yaml"},"# token\u914d\u7f6e\ntoken:\n  # \u662f\u5426\u542f\u52a8google\u8eab\u4efd\u9a8c\u8bc1\n  googleAuthenticator: true\n")),Object(o.b)("h4",{id:"\u4e8c-captchacontroller-\u6dfb\u52a0"},"\u4e8c. CaptchaController \u6dfb\u52a0"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\n    @Autowired\n    private TokenService tokenService;\n    \n      /**\n     * \u751f\u6210\u9a8c\u8bc1\u7801\n     */\n    @GetMapping("/isEnabledGoogleAuth")\n    public AjaxResult isEnabledGoogleAuth()  {\n        var ajax = AjaxResult.success();\n        ajax.put("isGoogleAuthenticatorEnabled", tokenService.isGoogleAuthenticator());\n        return ajax;\n    }\n\n')),Object(o.b)("h4",{id:"\u4e09-\u521b\u5efa\u51e0\u4e2a\u65b0\u7c7b"},"\u4e09. \u521b\u5efa\u51e0\u4e2a\u65b0\u7c7b"),Object(o.b)("h5",{id:"googleauthcodeexception"},"GoogleAuthCodeException"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\npackage com.ruoyi.common.exception.user;\n\n/**\n * GoogleAuthCodeException\n */\npublic class GoogleAuthCodeException extends UserException {\n    public GoogleAuthCodeException() {\n        super("user.google.not.match", null);\n    }\n}\n\n')),Object(o.b)("h5",{id:"googleauthenticator"},"GoogleAuthenticator"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'package com.ruoyi.common.utils;\n\nimport org.apache.commons.codec.binary.Base32;\nimport org.apache.commons.codec.binary.Hex;\n\nimport java.security.SecureRandom;\n\n/**\n * GoogleAuthenticator\n */\npublic class GoogleAuthenticator {\n    /**\n     * \u5fc5\u987b:\u521b\u5efa\u8c37\u6b4c\u79d8\u94a5\n     *\n     * @return\n     */\n    public static String generateSecretKey() {\n        SecureRandom random = new SecureRandom();\n        byte[] bytes = new byte[10];\n        random.nextBytes(bytes);\n        Base32 base32 = new Base32();\n        return base32.encodeToString(bytes);\n    }\n\n    /**\n     * \u751f\u62106\u4f4d\u6570\u5bc6\u7801\u8ddf\u524d\u7aef\u5339\u914d\n     *\n     * @param secretKey\n     * @return\n     */\n    public static String getTOTPCode(String secretKey) {\n        Base32 base32 = new Base32();\n        byte[] bytes = base32.decode(secretKey);\n        String hexKey = Hex.encodeHexString(bytes);\n        return TOTP.getOTP(hexKey);\n    }\n\n    /**\n     * \u751f\u62106\u4f4d\u6570\u5bc6\u7801\u8ddf\u524d\u7aef\u5339\u914d\n     * @param date\n     * @param secretKey\n     * @return\n     */\n    public static String getTOTPCode(String date,String secretKey) {\n        long cNowTime= DateUtils.dateTime(DateUtils.YYYY_MM_DD_HH_MM_SS,date).getTime()/30000;\n        Base32 base32 = new Base32();\n        byte[] bytes = base32.decode(secretKey);\n        String hexKey = Hex.encodeHexString(bytes);\n        return TOTP.getOTP(cNowTime,hexKey);\n    }\n\n    /**\n     * \u751f\u62106\u4f4d\u6570\u5bc6\u7801\u8ddf\u524d\u7aef\u5339\u914d\n     * @param date\n     * @param secretKey\n     * @return\n     */\n    public static String getTOTPCode(long date,String secretKey) {\n        long cNowTime= date/30000;\n        Base32 base32 = new Base32();\n        byte[] bytes = base32.decode(secretKey);\n        String hexKey = Hex.encodeHexString(bytes);\n        return TOTP.getOTP(cNowTime,hexKey);\n    }\n    /**\n     * \u53ea\u8981\u79d8\u94a5\u4e00\u6837.\u751f\u6210\u76846\u4f4d\u6570\u5c31\u662f\u4e00\u6837\u7684.  \u914d\u5408\u524d\u7aef\u8c37\u6b4c\u8eab\u4efd\u8bc1\u5668\u6d4b\u8bd5\u4e00\u4e0b\n     * @param args\n     */\n    public static void main(String[] args) {\n        String secretKey = generateSecretKey();\n        String totpCode = getTOTPCode(secretKey);\n        System.out.println(totpCode);\n        //       String secretKey = "FIFAMOCVMDAMQNL525FU66JJIEKBKY6V";\n//        String code = getTOTPCode(secretKey);\n        System.out.println(secretKey);\n    }\n}\n\n\n')),Object(o.b)("h5",{id:"googlecodeservice"},"GoogleCodeService"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\npackage com.ruoyi.framework.web.service;\n\nimport com.ruoyi.common.core.domain.entity.SysUser;\nimport com.ruoyi.common.exception.user.GoogleAuthCodeException;\nimport com.ruoyi.common.utils.GoogleAuthenticator;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Service;\n\nimport javax.servlet.http.HttpServletRequest;\n\n/**\n * GoogleCodeService\n */\n@Service\npublic class GoogleCodeService {\n    @Autowired\n    private HttpServletRequest request;\n\n    public void verifyGooglecode(SysUser user, String googlecode) throws GoogleAuthCodeException {\n        String value = request.getHeader("clientimestamp");\n        String totpCode = null;\n        if (null != value) {\n            totpCode = GoogleAuthenticator.getTOTPCode(Long.parseLong(value), user.getGooglekey());\n        } else {\n            totpCode = GoogleAuthenticator.getTOTPCode(user.getGooglekey());\n        }\n        if (org.springframework.util.StringUtils.isEmpty(googlecode) || !googlecode.equals(totpCode)) {\n            throw new GoogleAuthCodeException();\n        }\n    }\n\n}\n\n\n')),Object(o.b)("h5",{id:"totp"},"TOTP"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'package com.ruoyi.common.utils;\n\nimport javax.crypto.Mac;\nimport javax.crypto.spec.SecretKeySpec;\nimport java.lang.reflect.UndeclaredThrowableException;\nimport java.math.BigInteger;\nimport java.security.GeneralSecurityException;\n\n/**\n * Implementation of TOTP: Time-based One-time Password Algorithm\n *\n * @author thoeger\n */\npublic final class TOTP {\n\n    private TOTP() {\n        // private utility class constructor\n    }\n\n    /**\n     * @param key - secret credential key (HEX)\n     * @return the OTP\n     */\n    public static String getOTP(String key) {\n        return TOTP.getOTP(TOTP.getStep(), key);\n    }\n\n    /**\n     * @param key - secret credential key (HEX)\n     * @param otp - OTP to validate\n     * @return valid?\n     */\n    public static boolean validate(final String key, final String otp) {\n        return TOTP.validate(TOTP.getStep(), key, otp);\n    }\n\n    private static boolean validate(final long step, final String key, final String otp) {\n        return TOTP.getOTP(step, key).equals(otp) || TOTP.getOTP(step - 1, key).equals(otp);\n    }\n\n    private static long getStep() {\n        // 30 seconds StepSize (ID TOTP)\n        return System.currentTimeMillis() / 30000;\n    }\n\n    public static String getOTP(final long step, final String key) {\n        String steps = Long.toHexString(step).toUpperCase();\n        while (steps.length() < 16) {\n            steps = "0" + steps;\n        }\n\n        // Get the HEX in a Byte[]\n        final byte[] msg = TOTP.hexStr2Bytes(steps);\n        final byte[] k = TOTP.hexStr2Bytes(key);\n\n        final byte[] hash = TOTP.hmac_sha1(k, msg);\n\n        // put selected bytes into result int\n        final int offset = hash[hash.length - 1] & 0xf;\n        final int binary = ((hash[offset] & 0x7f) << 24) | ((hash[offset + 1] & 0xff) << 16) | ((hash[offset + 2] & 0xff) << 8) | (hash[offset + 3] & 0xff);\n        final int otp = binary % 1000000;\n\n        String result = Integer.toString(otp);\n        while (result.length() < 6) {\n            result = "0" + result;\n        }\n        return result;\n    }\n\n    /**\n     * This method converts HEX string to Byte[]\n     *\n     * @param hex the HEX string\n     *\n     * @return A byte array\n     */\n    private static byte[] hexStr2Bytes(final String hex) {\n        // Adding one byte to get the right conversion\n        // values starting with "0" can be converted\n        final byte[] bArray = new BigInteger("10" + hex, 16).toByteArray();\n        final byte[] ret = new byte[bArray.length - 1];\n\n        // Copy all the REAL bytes, not the "first"\n        System.arraycopy(bArray, 1, ret, 0, ret.length);\n        return ret;\n    }\n\n    /**\n     * This method uses the JCE to provide the crypto algorithm. HMAC computes a Hashed Message Authentication Code with the crypto hash\n     * algorithm as a parameter.\n     *\n     * @param keyBytes the bytes to use for the HMAC key\n     * @param text the message or text to be authenticated.\n     */\n    private static byte[] hmac_sha1(final byte[] keyBytes, final byte[] text) {\n        try {\n            final Mac hmac = Mac.getInstance("HmacSHA1");\n            final SecretKeySpec macKey = new SecretKeySpec(keyBytes, "RAW");\n            hmac.init(macKey);\n            return hmac.doFinal(text);\n        } catch (final GeneralSecurityException gse) {\n            throw new UndeclaredThrowableException(gse);\n        }\n    }\n\n}\n\n\n')),Object(o.b)("h4",{id:"\u56db-\u6dfb\u52a0\u65b0\u5b57\u6bb5"},"\u56db. \u6dfb\u52a0\u65b0\u5b57\u6bb5"),Object(o.b)("h5",{id:"loginbody"},"LoginBody"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"import lombok.Data;\n\n@Data\npublic class LoginBody {\n  private String googlecode;\n}\n")),Object(o.b)("h5",{id:"messagesproperties\u6dfb\u52a0\u7ffb\u8bd1"},"messages.properties\u6dfb\u52a0\u7ffb\u8bd1"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-text"},"user.google.not.match=googlecode\u6821\u9a8c\u5931\u8d25\n")),Object(o.b)("h5",{id:"securityconfig-\u6dfb\u52a0\u914d\u7f6e"},"SecurityConfig \u6dfb\u52a0\u914d\u7f6e"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\n.authorizeRequests.antMatchers("/login", "/captchaImage","/isEnabledGoogleAuth").anonymous()\n\n')),Object(o.b)("h5",{id:"sql\u6dfb\u52a0\u5b57\u6bb5"},"sql\u6dfb\u52a0\u5b57\u6bb5"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-sql"},"googlekey   VARCHAR(32)  DEFAULT '' COMMENT 'googlekey',\n\n\u6dfb\u52a0\u63d2\u5165\n\n'SWYKZ6EJWR3Y5XVHX5HZEHJJEEK7HIQZ'\n\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-sql"},"-- ----------------------------\n-- 2\u3001\u7528\u6237\u4fe1\u606f\u8868\n-- ----------------------------\nDROP TABLE IF EXISTS sys_user;\nCREATE TABLE sys_user\n(\n    user_id     BIGINT(20)  NOT NULL AUTO_INCREMENT COMMENT '\u7528\u6237ID',\n    user_name   VARCHAR(30) NOT NULL COMMENT '\u7528\u6237\u8d26\u53f7',\n    nick_name   VARCHAR(30) NOT NULL COMMENT '\u7528\u6237\u6635\u79f0',\n    user_type   VARCHAR(2)   DEFAULT '00' COMMENT '\u7528\u6237\u7c7b\u578b\uff0800\u7cfb\u7edf\u7528\u6237\uff09',\n    email       VARCHAR(50)  DEFAULT '' COMMENT '\u7528\u6237\u90ae\u7bb1',\n    phonenumber VARCHAR(11)  DEFAULT '' COMMENT '\u624b\u673a\u53f7\u7801',\n    googlekey   VARCHAR(32)  DEFAULT '' COMMENT 'googlekey',\n    sex         CHAR(1)      DEFAULT '0' COMMENT '\u7528\u6237\u6027\u522b\uff080\u7537 1\u5973\uff09',\n    avatar      VARCHAR(100) DEFAULT '' COMMENT '\u5934\u50cf\u5730\u5740',\n    password    VARCHAR(100) DEFAULT '' COMMENT '\u5bc6\u7801',\n    status      CHAR(1)      DEFAULT '0' COMMENT '\u5e10\u53f7\u72b6\u6001\uff080\u6b63\u5e38 1\u505c\u7528\uff09',\n    del_flag    CHAR(1)      DEFAULT '0' COMMENT '\u5220\u9664\u6807\u5fd7\uff080\u4ee3\u8868\u5b58\u5728 2\u4ee3\u8868\u5220\u9664\uff09',\n    login_ip    VARCHAR(128) DEFAULT '' COMMENT '\u6700\u540e\u767b\u5f55IP',\n    login_date  DATETIME COMMENT '\u6700\u540e\u767b\u5f55\u65f6\u95f4',\n    create_by   VARCHAR(64)  DEFAULT '' COMMENT '\u521b\u5efa\u8005',\n    create_time DATETIME COMMENT '\u521b\u5efa\u65f6\u95f4',\n    update_by   VARCHAR(64)  DEFAULT '' COMMENT '\u66f4\u65b0\u8005',\n    update_time DATETIME COMMENT '\u66f4\u65b0\u65f6\u95f4',\n    remark      VARCHAR(500) DEFAULT NULL COMMENT '\u5907\u6ce8',\n    PRIMARY KEY (user_id)\n) ENGINE = innodb\n  AUTO_INCREMENT = 100 COMMENT = '\u7528\u6237\u4fe1\u606f\u8868';\n\n-- ----------------------------\n-- \u521d\u59cb\u5316-\u7528\u6237\u4fe1\u606f\u8868\u6570\u636e\n-- ----------------------------\nINSERT INTO sys_user\nVALUES (1, 'admin', 'admin', '00', 'tao@163.com', '15888888888','SWYKZ6EJWR3Y5XVHX5HZEHJJEEK7HIQZ', '1', '',\n        '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', '0', '0', '127.0.0.1', SYSDATE(), 'admin',\n        SYSDATE(), '', NULL, '\u7ba1\u7406\u5458');\nINSERT INTO sys_user\nVALUES (2, 'tao', 'tao', '00', 'tao@qq.com', '15666666666','SWYKZ6EJWR3Y5XVHX5HZEHJJEEK7HIQZ', '1', '',\n        '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', '0', '0', '127.0.0.1', SYSDATE(), 'admin',\n        SYSDATE(), '', NULL, '\u6d4b\u8bd5\u5458');\n")),Object(o.b)("h4",{id:"\u4e94-\u6dfb\u52a0controller\u53c2\u6570"},"\u4e94. \u6dfb\u52a0controller\u53c2\u6570"),Object(o.b)("h5",{id:"syslogincontrollerjava"},"SysLoginController.java"),Object(o.b)("p",null,"\u6dfb\u52a0loginBody.getGooglecode()"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"\npublic AjaxResult login(@RequestBody LoginBody loginBody) {\n        AjaxResult ajax = AjaxResult.success();\n        // \u751f\u6210\u4ee4\u724c\n        String token = loginService.login(loginBody.getUsername(), loginBody.getPassword(), loginBody.getCode(),\n                loginBody.getUuid(),loginBody.getGooglecode());\n        ajax.put(Constants.TOKEN, token);\n        return ajax;\n    }\n    \n")),Object(o.b)("h5",{id:"sysloginservicejava"},"SysLoginService.java"),Object(o.b)("p",null,"\u6dfb\u52a0"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"    @Resource\n    GoogleCodeService googleCodeService;\n\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"   LoginUser principal = (LoginUser) authentication.getPrincipal();\n        SysUser user = principal.getUser();\n        if (tokenService.isGoogleAuthenticator()) {\n          googleCodeService.verifyGooglecode(user,googlecode);\n        }\n")),Object(o.b)("p",null,"\u5b8c\u5168\u7684\u53c2\u8003:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\n    @Resource\n    GoogleCodeService googleCodeService;\n\n    public String login(String username, String password, String code, String uuid, String googlecode)\n    {\n      // \u7528\u6237\u9a8c\u8bc1\n      Authentication authentication = null;\n      try\n      {\n        // \u8be5\u65b9\u6cd5\u4f1a\u53bb\u8c03\u7528UserDetailsServiceImpl.loadUserByUsername\n        authentication = authenticationManager\n          .authenticate(new UsernamePasswordAuthenticationToken(username, password));\n        LoginUser principal = (LoginUser) authentication.getPrincipal();\n        SysUser user = principal.getUser();\n        if (tokenService.isGoogleAuthenticator()) {\n          googleCodeService.verifyGooglecode(user,googlecode);\n        }\n      }\n      catch (Exception e)\n      {\n        if (e instanceof BadCredentialsException)\n        {\n          AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message("user.password.not.match")));\n          throw new UserPasswordNotMatchException();\n        }\n        else\n        {\n          AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));\n          throw new CustomException(e.getMessage());\n        }\n      }\n      AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message("user.login.success")));\n      LoginUser loginUser = (LoginUser) authentication.getPrincipal();\n      // \u751f\u6210token\n      return tokenService.createToken(loginUser);\n    }\n\n')),Object(o.b)("h5",{id:"sysuser\u7c7b\u6dfb\u52a0\u5b57\u6bb5"},"SysUser\u7c7b\u6dfb\u52a0\u5b57\u6bb5:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'\n    /** \u8c37\u6b4c\u5bc6\u94a5 */\n    @Excel(name = "googlekey")\n    private String googlekey;\n\n')),Object(o.b)("h5",{id:"sysusermapperxml-\u6dfb\u52a0"},"SysUserMapper.xml \u6dfb\u52a0"),Object(o.b)("p",null,"\u6ce8\u610f:\u7531\u4e8e\u4e1c\u897f\u591a,\u6240\u4ee5\u5efa\u8bae\u641c\u7d22googlekey\u5173\u952e\u5b57,\u6765\u533a\u5206\u6dfb\u52a0\u4e86\u4ec0\u4e48"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE mapper\n        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"\n        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">\n<mapper namespace="com.ruoyi.system.mapper.SysUserMapper">\n\n    <resultMap type="SysUser" id="SysUserResult">\n        <id property="userId" column="user_id"/>\n        <result property="userName" column="user_name"/>\n        <result property="nickName" column="nick_name"/>\n        <result property="email" column="email"/>\n        <result property="phonenumber" column="phonenumber"/>\n        <result property="googlekey"  column="googlekey"  />\n        <result property="sex" column="sex"/>\n        <result property="avatar" column="avatar"/>\n        <result property="password" column="password"/>\n        <result property="status" column="status"/>\n        <result property="delFlag" column="del_flag"/>\n        <result property="loginIp" column="login_ip"/>\n        <result property="loginDate" column="login_date"/>\n        <result property="createBy" column="create_by"/>\n        <result property="createTime" column="create_time"/>\n        <result property="updateBy" column="update_by"/>\n        <result property="updateTime" column="update_time"/>\n        <result property="remark" column="remark"/>\n        <collection property="roles" javaType="java.util.List" resultMap="RoleResult"/>\n    </resultMap>\n\n\n    <resultMap id="RoleResult" type="SysRole">\n        <id property="roleId" column="role_id"/>\n        <result property="roleName" column="role_name"/>\n        <result property="roleKey" column="role_key"/>\n        <result property="roleSort" column="role_sort"/>\n        <result property="dataScope" column="data_scope"/>\n        <result property="status" column="role_status"/>\n    </resultMap>\n\n    <sql id="selectUserVo">\n        SELECT u.user_id,\n        u.user_name,\n        u.nick_name,\n        u.email,\n        u.avatar,\n        u.phonenumber,\n        u.googlekey,\n        u.password,\n        u.sex,\n        u.status,\n        u.del_flag,\n        u.login_ip,\n        u.login_date,\n        u.create_by,\n        u.create_time,\n        u.remark,\n        r.role_id,\n        r.role_name,\n        r.role_key,\n        r.role_sort,\n        r.data_scope,\n        r.status AS role_status\n        FROM sys_user u\n        LEFT JOIN sys_user_role ur ON u.user_id = ur.user_id\n        LEFT JOIN sys_role r ON r.role_id = ur.role_id\n    </sql>\n\n    <select id="selectUserList" parameterType="SysUser" resultMap="SysUserResult">\n        select u.user_id, u.nick_name, u.user_name, u.email, u.avatar, u.phonenumber,u.googlekey, u.password, u.sex,\n        u.status, u.del_flag, u.login_ip, u.login_date, u.create_by, u.create_time, u.remark from sys_user u\n        where u.del_flag = \'0\'\n        <if test="userName != null and userName != \'\'">\n            AND u.user_name like concat(\'%\', #{userName}, \'%\')\n        </if>\n        <if test="status != null and status != \'\'">\n            AND u.status = #{status}\n        </if>\n        <if test="phonenumber != null and phonenumber != \'\'">\n            AND u.phonenumber like concat(\'%\', #{phonenumber}, \'%\')\n        </if>\n        <if test="params.beginTime != null and params.beginTime != \'\'">\x3c!-- \u5f00\u59cb\u65f6\u95f4\u68c0\u7d22 --\x3e\n            AND date_format(u.create_time,\'%y%m%d\') &gt;= date_format(#{params.beginTime},\'%y%m%d\')\n        </if>\n        <if test="params.endTime != null and params.endTime != \'\'">\x3c!-- \u7ed3\u675f\u65f6\u95f4\u68c0\u7d22 --\x3e\n            AND date_format(u.create_time,\'%y%m%d\') &lt;= date_format(#{params.endTime},\'%y%m%d\')\n        </if>\n        \x3c!-- \u6570\u636e\u8303\u56f4\u8fc7\u6ee4 --\x3e\n        ${params.dataScope}\n    </select>\n\n    <select id="selectUserByUserName" parameterType="String" resultMap="SysUserResult">\n        <include refid="selectUserVo"/>\n        where u.user_name = #{userName}\n    </select>\n\n    <select id="selectUserById" parameterType="Long" resultMap="SysUserResult">\n        <include refid="selectUserVo"/>\n        where u.user_id = #{userId}\n    </select>\n\n    <select id="checkUserNameUnique" parameterType="String" resultType="int">\n        SELECT COUNT(1)\n        FROM sys_user\n        WHERE user_name = #{userName}\n        LIMIT 1\n    </select>\n\n    <select id="checkPhoneUnique" parameterType="String" resultMap="SysUserResult">\n        SELECT user_id, phonenumber\n        FROM sys_user\n        WHERE phonenumber = #{phonenumber}\n        LIMIT 1\n    </select>\n\n    <select id="checkEmailUnique" parameterType="String" resultMap="SysUserResult">\n        SELECT user_id, email\n        FROM sys_user\n        WHERE email = #{email}\n        LIMIT 1\n    </select>\n\n    <insert id="insertUser" parameterType="SysUser" useGeneratedKeys="true" keyProperty="userId">\n        insert into sys_user(\n        <if test="userId != null and userId != 0">user_id,</if>\n        <if test="userName != null and userName != \'\'">user_name,</if>\n        <if test="nickName != null and nickName != \'\'">nick_name,</if>\n        <if test="email != null and email != \'\'">email,</if>\n        <if test="avatar != null and avatar != \'\'">avatar,</if>\n        <if test="phonenumber != null and phonenumber != \'\'">phonenumber,</if>\n        <if test="googlekey != null and googlekey != \'\'">googlekey,</if>\n        <if test="sex != null and sex != \'\'">sex,</if>\n        <if test="password != null and password != \'\'">password,</if>\n        <if test="status != null and status != \'\'">status,</if>\n        <if test="createBy != null and createBy != \'\'">create_by,</if>\n        <if test="remark != null and remark != \'\'">remark,</if>\n        create_time\n        )values(\n        <if test="userId != null and userId != \'\'">#{userId},</if>\n        <if test="userName != null and userName != \'\'">#{userName},</if>\n        <if test="nickName != null and nickName != \'\'">#{nickName},</if>\n        <if test="email != null and email != \'\'">#{email},</if>\n        <if test="avatar != null and avatar != \'\'">#{avatar},</if>\n        <if test="phonenumber != null and phonenumber != \'\'">#{phonenumber},</if>\n        <if test="googlekey != null and googlekey != \'\'">#{googlekey},</if>\n        <if test="sex != null and sex != \'\'">#{sex},</if>\n        <if test="password != null and password != \'\'">#{password},</if>\n        <if test="status != null and status != \'\'">#{status},</if>\n        <if test="createBy != null and createBy != \'\'">#{createBy},</if>\n        <if test="remark != null and remark != \'\'">#{remark},</if>\n        sysdate()\n        )\n    </insert>\n\n    <update id="updateUser" parameterType="SysUser">\n        update sys_user\n        <set>\n            <if test="userName != null and userName != \'\'">user_name = #{userName},</if>\n            <if test="nickName != null and nickName != \'\'">nick_name = #{nickName},</if>\n            <if test="email != null ">email = #{email},</if>\n            <if test="phonenumber != null ">phonenumber = #{phonenumber},</if>\n            <if test="googlekey != null and googlekey != \'\'">googlekey = #{googlekey},</if>\n            <if test="sex != null and sex != \'\'">sex = #{sex},</if>\n            <if test="avatar != null and avatar != \'\'">avatar = #{avatar},</if>\n            <if test="password != null and password != \'\'">password = #{password},</if>\n            <if test="status != null and status != \'\'">status = #{status},</if>\n            <if test="loginIp != null and loginIp != \'\'">login_ip = #{loginIp},</if>\n            <if test="loginDate != null">login_date = #{loginDate},</if>\n            <if test="updateBy != null and updateBy != \'\'">update_by = #{updateBy},</if>\n            <if test="remark != null">remark = #{remark},</if>\n            update_time = sysdate()\n        </set>\n        where user_id = #{userId}\n    </update>\n\n    <update id="updateUserStatus" parameterType="SysUser">\n        UPDATE sys_user\n        SET status = #{status}\n        WHERE user_id = #{userId}\n    </update>\n\n    <update id="updateUserAvatar" parameterType="SysUser">\n        UPDATE sys_user\n        SET avatar = #{avatar}\n        WHERE user_name = #{userName}\n    </update>\n\n    <update id="resetUserPwd" parameterType="SysUser">\n        UPDATE sys_user\n        SET password = #{password}\n        WHERE user_name = #{userName}\n    </update>\n\n    <delete id="deleteUserById" parameterType="Long">\n        DELETE\n        FROM sys_user\n        WHERE user_id = #{userId}\n    </delete>\n\n    <delete id="deleteUserByIds" parameterType="Long">\n        update sys_user set del_flag = \'2\' where user_id in\n        <foreach collection="array" item="userId" open="(" separator="," close=")">\n            #{userId}\n        </foreach>\n    </delete>\n\n</mapper>\n\n')),Object(o.b)("h5",{id:"tokenservicejava"},"TokenService.java"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'    @Data\n    public class TokenService\n    {\n        // \u662f\u5426\u542f\u52a8google\u8eab\u4efd\u9a8c\u8bc1\n        @Value("${token.googleAuthenticator}")\n        private boolean googleAuthenticator;\n\n')),Object(o.b)("h3",{id:"2-\u524d\u7aef\u7684\u6dfb\u52a0"},"(2). \u524d\u7aef\u7684\u6dfb\u52a0"),Object(o.b)("h4",{id:"userindexvue"},"user/index.vue"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-html"},'\u6dfb\u52a0\u5c55\u793a\n<el-table-column label="google key" align="center" prop="googlekey"  />\n\n\u6dfb\u52a0form\u5b57\u6bb5\n\n<el-col :span="12">\n  <el-form-item label="googlekey" prop="googlekey">\n    <el-input v-model="form.googlekey" placeholder="googlekey"  />\n  </el-form-item>\n</el-col>\n\n\n')),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"}," this.form = {\n  googlekey: undefined,\n}\n")),Object(o.b)("h4",{id:"loginjs"},"login.js"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"##\u52a0\u5b57\u6bb5\nexport function login(username, password, code, uuid, googlecode) {\n  const data = {\n    username,\n    password,\n    code,\n    uuid,\n    googlecode\n  }\n  return request({\n    url: '/login',\n    method: 'post',\n    data: data\n  })\n}\n\n\u521b\u5efa\u65b9\u6cd5:\n\n// \u83b7\u53d6\u9a8c\u8bc1\u7801\n  export function getIsEnabledGoogleAuth() {\n    return request({\n      url: '/isEnabledGoogleAuth',\n      method: 'get'\n    })\n  }\n  \n  \n")),Object(o.b)("h4",{id:"loginvue"},"login.vue"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-html"},'\u6dfb\u52a0form\n\n<el-form-item v-if="isGoogleAuthenticatorEnabled">\n  <el-input v-model="loginForm.googlecode" type="number" placeholder="google code"  @keyup.enter.native="handleLogin">\n  </el-input>\n</el-form-item>\n\n\n')),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"import {getIsEnabledGoogleAuth } from '@/api/login'\n\ndata() {\n  return {\n    isGoogleAuthenticatorEnabled: false,\n    loginForm: {\n      googlecode: \"\"\n    },\n  }\n},\ncreated() {\n  this.getIsEnabledGoogleAuth();\n},\nmethods: {\n  getIsEnabledGoogleAuth() {\n    getIsEnabledGoogleAuth().then(res => {\n      if (res) {\n        this.isGoogleAuthenticatorEnabled = res.isGoogleAuthenticatorEnabled;\n      }\n    });\n  },\n")),Object(o.b)("h4",{id:"requestjs"},"request.js"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"service.interceptors.request.use(config => {\n  config.headers['clientimestamp'] = Date.now();\n}\n")),Object(o.b)("h4",{id:"userjs"},"user.js"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"actions: {\n // \u767b\u5f55\n    Login({ commit }, userInfo) {\n      const googlecode = userInfo.googlecode\n      return new Promise((resolve, reject) => {\n        login(username, password, code, uuid, googlecode).then(res => {\n      })\n    },\n")),Object(o.b)("h2",{id:"4\u5b57\u6bb5\u65e5\u671f\u683c\u5f0f\u5316"},"4.\u5b57\u6bb5\u65e5\u671f\u683c\u5f0f\u5316"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-shell"},' import com.fasterxml.jackson.annotation.JsonFormat;\n\n\n@JsonFormat(pattern = "yyyy-MM-dd")\nprivate Date endTime;\n\n\n\u5e26\u65f6\u5206\u79d2\u7684:\n\n@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")\nprivate Date operTime;\n\n')),Object(o.b)("h2",{id:"5\u81ea\u5b9a\u4e49dto\u8f6c\u5316\u5668\u5982\u628a\u6570\u7ec4\u8f6c\u6210string"},"5.\u81ea\u5b9a\u4e49dto\u8f6c\u5316\u5668,\u5982,\u628a\u6570\u7ec4\u8f6c\u6210String"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'    @Excel(name = "\u53d1\u5e03\u5bf9\u8c61")\n    @JsonSerialize(using = ArrayToStringJsonSerializer.class)\n    @JsonDeserialize(using = StringJsonDeserializer.class)\n    private String identity;\n\n')),Object(o.b)("p",null,"ArrayToStringJsonSerializer\u7684\u5185\u5bb9:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"import com.fasterxml.jackson.core.JsonGenerator;\nimport com.fasterxml.jackson.databind.JsonSerializer;\nimport com.fasterxml.jackson.databind.SerializerProvider;\n\nimport java.io.IOException;\n\n/**\n * ArrayToStringJsonSerializer\n *\n * \n */\npublic class ArrayToStringJsonSerializer extends JsonSerializer<String> {\n\n    @Override\n    public void serialize(String value, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {\n        String text = (value==null ? null:String.valueOf(value));\n        if (text!=null) {\n            jsonGenerator.writeString(text);\n        }\n    }\n}\n")),Object(o.b)("p",null,"StringJsonDeserializer\u7684\u5185\u5bb9:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"import com.fasterxml.jackson.core.JsonParser;\nimport com.fasterxml.jackson.databind.DeserializationContext;\nimport com.fasterxml.jackson.databind.JsonDeserializer;\n\nimport java.io.IOException;\n\n/**\n * StringJsonDeserializer\n */\npublic class StringJsonDeserializer extends JsonDeserializer<String> {\n\n    @Override\n    public String deserialize(JsonParser jsonParser, DeserializationContext deserializationContext) throws IOException {\n        return jsonParser.getText();\n    }\n}\n")),Object(o.b)("h2",{id:"6\u5e38\u89c1mybatis\u5b9e\u4f53html"},"6.\u5e38\u89c1mybatis\u5b9e\u4f53html"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-html"},"\n<if test='createTime != null '> and CREATE_TIME &gt;= #{createTime}</if>\n<if test='updateTime != null '> and CREATE_TIME &lt;= #{updateTime}</if>\n\n\n<:\u7684\u5b9e\u4f53\u6807\u7b7e:\n  &lt;\n>:\u7684\u5b9e\u4f53\u6807\u7b7e:\n  &gt;\n\n  <>\u7684\u5b9e\u4f53\u6807\u7b7e:\n  &lt;&gt;\n\n")),Object(o.b)("h2",{id:"7-import\u5bfc\u5165\u7684\u5b9e\u73b0"},"7. import\u5bfc\u5165\u7684\u5b9e\u73b0"),Object(o.b)("h3",{id:"1-java-\u5b9e\u73b0"},"(1) java \u5b9e\u73b0"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-typescript",metastring:"jsx",jsx:!0},'\n    @Log(title = "\u5bfc\u5165\u6570\u636e", businessType = BusinessType.IMPORT)\n    @PreAuthorize("@ss.hasPermi(\'chessandcardchallenge:dataimport:import\')")\n    @PostMapping("/importData")\n    public AjaxResult importData(MultipartFile file, boolean updateSupport) throws Exception {\n        ExcelUtil<MacauChesscardchallengeDataimport> util = new ExcelUtil<>(MacauChesscardchallengeDataimport.class);\n        List<MacauChesscardchallengeDataimport> userList = util.importExcel(file.getInputStream());\n        LoginUser loginUser = tokenService.getLoginUser(ServletUtils.getRequest());\n        String operName = loginUser.getUsername();\n        String message = macauChesscardchallengeDataimportService.importUser(userList, updateSupport, operName);\n        return AjaxResult.success(message);\n    }\n    \n    @GetMapping("/importTemplate")\n    public AjaxResult importTemplate() {\n        ExcelUtil<MacauChesscardchallengeDataimport> util = new ExcelUtil<>(MacauChesscardchallengeDataimport.class);\n        return util.importTemplateExcel("\u5bfc\u5165\u6570\u636e");\n    }\n\n')),Object(o.b)("h3",{id:"2-vue\u5b9e\u73b0"},"(2) vue\u5b9e\u73b0"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-html"},"\n\n<template>\n\n  <el-col :span=\"1.5\">\n    <el-button\n      type=\"info\"\n      plain\n      icon=\"el-icon-upload2\"\n      size=\"mini\"\n      @click=\"handleImport\"\n      v-hasPermi=\"['chessandcardchallenge:dataimport:import']\"\n    >\u5bfc\u5165\n    </el-button>\n  </el-col>\n  \n  \n  \x3c!-- \u7528\u6237\u5bfc\u5165\u5bf9\u8bdd\u6846 --\x3e\n  <el-dialog :title='upload.title' :visible.sync='upload.open' width='400px' append-to-body>\n    <el-upload\n      ref='upload'\n      :limit='1'\n      accept='.xlsx, .xls'\n      :headers='upload.headers'\n      :action=\"upload.url + '?updateSupport=' + upload.updateSupport\"\n      :disabled='upload.isUploading'\n      :on-progress='handleFileUploadProgress'\n      :on-success='handleFileSuccess'\n      :auto-upload='false'\n      drag\n    >\n      <i class='el-icon-upload'></i>\n      <div class='el-upload__text'>\n        \u5c06\u6587\u4ef6\u62d6\u5230\u6b64\u5904\uff0c\u6216\n        <em>\u70b9\u51fb\u4e0a\u4f20</em>\n      </div>\n      <div class='el-upload__tip' slot='tip'>\n        <el-checkbox v-model='upload.updateSupport' />\n        \u662f\u5426\u66f4\u65b0\u5df2\u7ecf\u5b58\u5728\u7684\u7528\u6237\u6570\u636e\n        <el-link type='info' style='font-size:12px' @click='importTemplate'>\u4e0b\u8f7d\u6a21\u677f</el-link>\n      </div>\n      <div class='el-upload__tip' style='color:red' slot='tip'>\u63d0\u793a\uff1a\u4ec5\u5141\u8bb8\u5bfc\u5165\u201cxls\u201d\u6216\u201cxlsx\u201d\u683c\u5f0f\u6587\u4ef6\uff01</div>\n    </el-upload>\n    <div slot='footer' class='dialog-footer'>\n      <el-button type='primary' @click='submitFileForm'>\u786e \u5b9a</el-button>\n      <el-button @click='upload.open = false'>\u53d6 \u6d88</el-button>\n    </div>\n  </el-dialog>\n</template>\n\n<script>\nimport {getToken} from \"@/utils/auth\";\n// \u4e0b\u8f7d\u7528\u6237\u5bfc\u5165\u6a21\u677f\nfunction importTemplate() {\n  return request({\n    url: '/chessandcardchallenge/dataimport/importTemplate',\n    method: 'get'\n  })\n}\n\nexport default {\n  name: \"Dataimport\",\n  components: {},\n  data() {\n    return {\n      upload: {\n        // \u662f\u5426\u663e\u793a\u5f39\u51fa\u5c42\uff08\u6570\u636e\u5bfc\u5165\uff09\n        open: false,\n        // \u5f39\u51fa\u5c42\u6807\u9898\uff08\u6570\u636e\u5bfc\u5165\uff09\n        title: \"\",\n        // \u662f\u5426\u7981\u7528\u4e0a\u4f20\n        isUploading: false,\n        // \u662f\u5426\u66f4\u65b0\u5df2\u7ecf\u5b58\u5728\u7684\u6570\u636e\u6570\u636e\n        updateSupport: 0,\n        // \u8bbe\u7f6e\u4e0a\u4f20\u7684\u8bf7\u6c42\u5934\u90e8\n        headers: {Authorization: \"Bearer \" + getToken()},\n        // \u4e0a\u4f20\u7684\u5730\u5740\n        url: process.env.VUE_APP_BASE_API + \"/chessandcardchallenge/dataimport/importData\"\n      },\n    };\n  },\n  methods: {\n    /** \u4e0b\u8f7d\u6a21\u677f\u64cd\u4f5c */\n    importTemplate() {\n      importTemplate().then(response => {\n        this.download(response.msg);\n      });\n    },\n    // \u63d0\u4ea4\u4e0a\u4f20\u6587\u4ef6\n    submitFileForm() {\n      this.$refs.upload.submit();\n    },\n    /** \u5bfc\u5165\u6309\u94ae\u64cd\u4f5c */\n    handleImport() {\n      this.upload.title = \"\u6570\u636e\u5bfc\u5165\";\n      this.upload.open = true;\n    },\n    // \u6587\u4ef6\u4e0a\u4f20\u4e2d\u5904\u7406\n    handleFileUploadProgress(event, file, fileList) {\n      this.upload.isUploading = true;\n    },\n    // \u6587\u4ef6\u4e0a\u4f20\u6210\u529f\u5904\u7406\n    handleFileSuccess(response, file, fileList) {\n      this.upload.open = false;\n      this.upload.isUploading = false;\n      this.$refs.upload.clearFiles();\n      this.$alert(response.msg, \"\u5bfc\u5165\u7ed3\u679c\", {dangerouslyUseHTMLString: true});\n      this.getList();\n    },\n  }\n};\n<\/script>\n\n")),Object(o.b)("h2",{id:"8ruoyi\u591a\u6570\u636e\u6e90"},"8.ruoyi\u591a\u6570\u636e\u6e90"),Object(o.b)("p",null,"\u5728\u5b9e\u9645\u5f00\u53d1\u4e2d\uff0c\u7ecf\u5e38\u53ef\u80fd\u9047\u5230\u5728\u4e00\u4e2a\u5e94\u7528\u4e2d\u53ef\u80fd\u9700\u8981\u8bbf\u95ee\u591a\u4e2a\u6570\u636e\u5e93\u7684\u60c5\u51b5\n\u5728\u9700\u8981\u5207\u6362\u6570\u636e\u6e90",Object(o.b)("inlineCode",{parentName:"p"},"Service"),"\u6216",Object(o.b)("inlineCode",{parentName:"p"},"Mapper"),"\u65b9\u6cd5\u4e0a\u6dfb\u52a0",Object(o.b)("inlineCode",{parentName:"p"},"@DataSource"),"\u6ce8\u89e3\n",Object(o.b)("inlineCode",{parentName:"p"},"@DataSource(value = DataSourceType.MASTER)"),"\uff0c\u5176\u4e2d",Object(o.b)("inlineCode",{parentName:"p"},"value"),"\u7528\u6765\u8868\u793a\u6570\u636e\u6e90\u540d\u79f0"),Object(o.b)("p",null,"\u63d0\u793a"),Object(o.b)("p",null,"\u5173\u4e8e\u591a\u6570\u636e\u6e90\u4f7f\u7528\u6d41\u7a0b\uff08\u5982\u679c\u6709\u591a\u4e2a\uff0c\u53ef\u4ee5\u53c2\u8003slave\u6dfb\u52a0\uff09"),Object(o.b)("p",null,"\u652f\u6301\u53c2\u6570\u5982\u4e0b\uff1a"),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",{parentName:"tr",align:null},"\u53c2\u6570"),Object(o.b)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),Object(o.b)("th",{parentName:"tr",align:null},"\u9ed8\u8ba4\u503c"),Object(o.b)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",{parentName:"tr",align:null},"value"),Object(o.b)("td",{parentName:"tr",align:null},"DataSourceType"),Object(o.b)("td",{parentName:"tr",align:null},"DataSourceType.MASTER"),Object(o.b)("td",{parentName:"tr",align:null},"\u4e3b\u5e93")))),Object(o.b)("p",null,"1\u3001\u5728",Object(o.b)("inlineCode",{parentName:"p"},"application-druid.yml"),"\u914d\u7f6e\u4ece\u5e93\u6570\u636e\u6e90"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-yaml"},"# \u4ece\u5e93\u6570\u636e\u6e90\nslave:\n    # \u4ece\u6570\u636e\u6e90\u5f00\u5173/\u9ed8\u8ba4\u5173\u95ed\n    enabled: true\n    url: jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8\n    username: root\n    password: password\n")),Object(o.b)("p",null,"2\u3001\u5728",Object(o.b)("inlineCode",{parentName:"p"},"DataSourceType"),"\u7c7b\u6dfb\u52a0\u6570\u636e\u6e90\u679a\u4e3e"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"/**\n * \u4ece\u5e93\n */\nSLAVE\n")),Object(o.b)("p",null,"3\u3001\u5728",Object(o.b)("inlineCode",{parentName:"p"},"DruidConfig"),"\u914d\u7f6e\u8bfb\u53d6\u6570\u636e\u6e90"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'@Bean\n@ConfigurationProperties("spring.datasource.druid.slave")\n@ConditionalOnProperty(prefix = "spring.datasource.druid.slave", name = "enabled", havingValue = "true")\npublic DataSource slaveDataSource(DruidProperties druidProperties)\n{\n    DruidDataSource dataSource = DruidDataSourceBuilder.create().build();\n    return druidProperties.dataSource(dataSource);\n}\n')),Object(o.b)("p",null,"4\u3001\u5728",Object(o.b)("inlineCode",{parentName:"p"},"DruidConfig"),"\u7c7b",Object(o.b)("inlineCode",{parentName:"p"},"dataSource"),"\u65b9\u6cd5\u6dfb\u52a0\u6570\u636e\u6e90"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},'setDataSource(targetDataSources, DataSourceType.SLAVE.name(), "slaveDataSource");\n')),Object(o.b)("p",null,"5\u3001\u5728\u9700\u8981\u4f7f\u7528\u591a\u6570\u636e\u6e90\u65b9\u6cd5\u6216\u7c7b\u4e0a\u6dfb\u52a0",Object(o.b)("inlineCode",{parentName:"p"},"@DataSource"),"\u6ce8\u89e3\uff0c\u5176\u4e2d",Object(o.b)("inlineCode",{parentName:"p"},"value"),"\u7528\u6765\u8868\u793a\u6570\u636e\u6e90"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"@DataSource(value = DataSourceType.SLAVE)\npublic List<SysUser> selectUserList(SysUser user)\n{\n    return userMapper.selectUserList(user);\n}\n")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"@Service\n@DataSource(value = DataSourceType.SLAVE)\npublic class SysUserServiceImpl\n")),Object(o.b)("p",null,"\u5bf9\u4e8e\u7279\u6b8a\u60c5\u51b5\u53ef\u4ee5\u901a\u8fc7",Object(o.b)("inlineCode",{parentName:"p"},"DynamicDataSourceContextHolder"),"\u624b\u52a8\u5b9e\u73b0\u6570\u636e\u6e90\u5207\u6362"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"public List<SysUser> selectUserList(SysUser user)\n{\n    DynamicDataSourceContextHolder.setDataSourceType(DataSourceType.SLAVE.name());\n    List<SysUser> userList = userMapper.selectUserList(user);\n    DynamicDataSourceContextHolder.clearDataSourceType();\n    return userList;\n}\n")),Object(o.b)("p",null,"\u903b\u8f91\u5b9e\u73b0\u4ee3\u7801 ",Object(o.b)("inlineCode",{parentName:"p"},"com.ruoyi.framework.aspectj.DataSourceAspect")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-javascript"},"\u6ce8\u610f\uff1a\u76ee\u524d\u914d\u7f6e\u4e86\u4e00\u4e2a\u4ece\u5e93\uff0c\u9ed8\u8ba4\u5173\u95ed\u72b6\u6001\u3002\u5982\u679c\u4e0d\u9700\u8981\u591a\u6570\u636e\u6e90\u4e0d\u7528\u505a\u4efb\u4f55\u914d\u7f6e\u3002 \u53e6\u5916\u53ef\u65b0\u589e\u591a\u4e2a\u4ece\u5e93\u3002\u652f\u6301\u4e0d\u540c\u6570\u636e\u6e90\uff08Mysql\u3001Oracle\u3001SQLServer\uff09\n")),Object(o.b)("p",null,"\u63d0\u793a"),Object(o.b)("p",null,"\u5982\u679c\u6709Service\u65b9\u6cd5\u5185\u591a\u4e2a\u6ce8\u89e3\u65e0\u6548\u7684\u60c5\u51b5\u4f7f\u7528\u5185\u90e8\u65b9\u6cd5\u8c03\u7528\nSpringUtils.getAopProxy(this).xxxxxx(xxxx);"))}u.isMDXComponent=!0},97:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return g}));var r=t(0),a=t.n(r);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var c=a.a.createContext({}),u=function(e){var n=a.a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=u(e.components);return a.a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},m=a.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(t),m=r,g=p["".concat(i,".").concat(m)]||p[m]||d[m]||o;return t?a.a.createElement(g,s(s({ref:n},c),{},{components:t})):a.a.createElement(g,s({ref:n},c))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=t[c];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,t)}m.displayName="MDXCreateElement"}}]);